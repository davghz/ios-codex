#!/bin/sh
set -e

CODEX_JS="/usr/local/lib/node_modules/@openai/codex/bin/codex.js"
CODEX_BIN="/usr/local/lib/node_modules/@openai/codex/vendor/aarch64-apple-ios/codex/codex"
NODE22_BIN="/usr/local/bin/node22"
NODE_WRAPPER="/usr/local/bin/node"
CODEX_LAUNCHER="/usr/local/bin/codex"
CODEX_SHIM="/usr/bin/codex"

if [ -f "$CODEX_JS" ] && command -v node >/dev/null 2>&1; then
  CODEX_JS="$CODEX_JS" node <<'NODE'
const fs = require('fs');
const path = process.env.CODEX_JS;
if (!path || !fs.existsSync(path)) process.exit(0);
let src = fs.readFileSync(path, 'utf8');
let changed = false;

if (!src.includes('"aarch64-apple-ios"')) {
  src = src.replace(
    /(\s+"aarch64-apple-darwin":\s+"@openai\/codex-darwin-arm64",\n)/,
    '$1  "aarch64-apple-ios": "@openai/codex-ios-arm64",\n',
  );
  changed = true;
}

if (!src.includes('case "ios":')) {
  src = src.replace(
    /\n\s+case "win32":/,
    '\n  case "ios":\n    switch (arch) {\n      case "arm64":\n        targetTriple = "aarch64-apple-ios";\n        break;\n      default:\n        break;\n    }\n    break;\n  case "win32":',
  );
  changed = true;
}

if (changed) {
  const backup = `${path}.bak.${Date.now()}`;
  fs.copyFileSync(path, backup);
  fs.writeFileSync(path, src);
  console.log(`[codex-ios] patched ${path}`);
} else {
  console.log('[codex-ios] codex.js already patched for iOS');
}
NODE
fi

if [ -f "$CODEX_BIN" ] && command -v ldid >/dev/null 2>&1; then
  ldid -S "$CODEX_BIN" || true
fi

if [ -f "$CODEX_BIN" ]; then
  chown root:wheel "$CODEX_BIN" || true
  chmod 755 "$CODEX_BIN" || true
fi

if [ -f "$NODE22_BIN" ]; then
  cat >"$NODE_WRAPPER" <<'EOF'
#!/bin/sh
# iOS 13 stability flags for Node.js 22 under jailbreak environments.
NODE_ARGS="--jitless --max-opt=0 --no-sparkplug --max-old-space-size=512 --disable-wasm-trap-handler"
exec /usr/local/bin/node22 $NODE_ARGS "$@"
EOF
  chmod 755 "$NODE_WRAPPER"
fi

cat >"$CODEX_LAUNCHER" <<'EOF'
#!/bin/sh
# Stable iOS launcher for Codex in NewTerm2/mobile shells.
PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
export PATH
exec /usr/local/bin/node22 --jitless --max-opt=0 --no-sparkplug --max-old-space-size=512 --disable-wasm-trap-handler /usr/local/lib/node_modules/@openai/codex/bin/codex.js "$@"
EOF
chmod 755 "$CODEX_LAUNCHER"

if [ -d /usr/bin ]; then
  cat >"$CODEX_SHIM" <<'EOF'
#!/bin/sh
exec /usr/local/bin/codex "$@"
EOF
  chmod 755 "$CODEX_SHIM" || true
fi

if [ -f "$NODE22_BIN" ] && command -v ldid >/dev/null 2>&1; then
  ldid -S "$NODE22_BIN" || true
fi

exit 0
