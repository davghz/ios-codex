#!/bin/sh
set -e

PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
export PATH

if [ "$(id -u)" -ne 0 ]; then
  if [ -n "${1:-}" ]; then
    exec su -c "/usr/local/bin/codex-update \"$1\""
  else
    exec su -c "/usr/local/bin/codex-update"
  fi
fi

NPM_BIN="/usr/local/bin/npm22"
NPM_CLI="/usr/local/lib/node22/node_modules/npm/bin/npm-cli.js"
REPAIR="/usr/local/libexec/codex-ios-repair"
IOS_BIN_STABLE="/usr/local/lib/codex-ios/codex"
IOS_VENDOR_BIN="/usr/local/lib/node_modules/@openai/codex/vendor/aarch64-apple-ios/codex/codex"
IOS_DARWIN_VENDOR_BIN="/usr/local/lib/node_modules/@openai/codex-darwin-arm64/vendor/aarch64-apple-ios/codex/codex"
PKG="${1:-@openai/codex@latest}"
MAX_ATTEMPTS="${MAX_ATTEMPTS:-3}"
STABLE_NODE_FLAGS="--max-opt=0 --no-sparkplug --max-old-space-size=512 --disable-wasm-trap-handler"

if [ ! -x "$NPM_BIN" ]; then
  echo "missing $NPM_BIN" >&2
  exit 1
fi

attempt=1
while [ "$attempt" -le "$MAX_ATTEMPTS" ]; do
  echo "[codex-update] attempt ${attempt}/${MAX_ATTEMPTS}: npm22 install -g ${PKG}"
  if [ -x /usr/local/bin/node22 ] && [ -f "$NPM_CLI" ]; then
    INSTALL_OK=0
    # Run npm via node22 directly to apply stability flags without NODE_OPTIONS restrictions.
    /usr/local/bin/node22 $STABLE_NODE_FLAGS "$NPM_CLI" install -g "$PKG" || INSTALL_OK=$?
    if [ "$INSTALL_OK" -eq 0 ]; then
      break
    fi
  elif "$NPM_BIN" install -g "$PKG"; then
    break
  fi
  if [ "$attempt" -ge "$MAX_ATTEMPTS" ]; then
    echo "[codex-update] npm install failed after ${MAX_ATTEMPTS} attempts" >&2
    exit 1
  fi
  sleep "$attempt"
  attempt=$((attempt + 1))
done

if [ -x "$REPAIR" ]; then
  "$REPAIR"
else
  echo "[codex-update] warning: repair helper missing ($REPAIR)" >&2
fi

INSTALLED_VER="$(/usr/local/bin/node22 -e 'try{process.stdout.write(require("/usr/local/lib/node_modules/@openai/codex/package.json").version)}catch(e){process.stdout.write("")}' 2>/dev/null || true)"
if [ -n "$INSTALLED_VER" ]; then
  CURRENT_BIN_VER=""
  if [ -x "$IOS_BIN_STABLE" ]; then
    set -- $("$IOS_BIN_STABLE" --version 2>/dev/null || true)
    CURRENT_BIN_VER="${2:-}"
  fi
  if [ -n "$CURRENT_BIN_VER" ] && [ "$CURRENT_BIN_VER" != "$INSTALLED_VER" ] && [ "${#CURRENT_BIN_VER}" -eq "${#INSTALLED_VER}" ]; then
    if /usr/local/bin/node22 $STABLE_NODE_FLAGS - "$CURRENT_BIN_VER" "$INSTALLED_VER" "$IOS_BIN_STABLE" "$IOS_VENDOR_BIN" "$IOS_DARWIN_VENDOR_BIN" <<'NODE'
const fs = require("fs");
const from = Buffer.from(process.argv[2] || "", "utf8");
const to = Buffer.from(process.argv[3] || "", "utf8");
const paths = process.argv.slice(4);
if (from.length === 0 || from.length !== to.length) process.exit(0);
for (const path of paths) {
  if (!path || !fs.existsSync(path)) continue;
  const buf = fs.readFileSync(path);
  let replaced = 0;
  for (let i = 0; i <= buf.length - from.length; i++) {
    let match = true;
    for (let j = 0; j < from.length; j++) {
      if (buf[i + j] !== from[j]) {
        match = false;
        break;
      }
    }
    if (!match) continue;
    to.copy(buf, i);
    replaced++;
    i += from.length - 1;
  }
  if (replaced > 0) {
    fs.writeFileSync(path, buf);
    console.log(`[codex-update] synced binary version in ${path} (${replaced} replacements)`);
  }
}
NODE
    then
      :
    else
      echo "[codex-update] warning: failed to sync binary version strings" >&2
    fi
    if command -v ldid >/dev/null 2>&1; then
      for f in "$IOS_BIN_STABLE" "$IOS_VENDOR_BIN" "$IOS_DARWIN_VENDOR_BIN"; do
        [ -f "$f" ] && ldid -S "$f" || true
      done
    fi
    [ -x "$REPAIR" ] && "$REPAIR" >/dev/null 2>&1 || true
  fi

  VERSION_JSON="/var/mobile/.codex/version.json"
  mkdir -p /var/mobile/.codex
  NOW_UTC="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  printf '{"latest_version":"%s","last_checked_at":"%s","dismissed_version":"%s"}\n' \
    "$INSTALLED_VER" "$NOW_UTC" "$INSTALLED_VER" > "$VERSION_JSON"
  chown mobile:mobile "$VERSION_JSON" 2>/dev/null || true
  chmod 600 "$VERSION_JSON" 2>/dev/null || true
fi

su mobile -c 'PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin codex --version' || true
echo "[codex-update] done"
